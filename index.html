<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Scatter Generator</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/material-design-lite/1.3.0/material.indigo-pink.min.css">
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/material-design-lite/1.3.0/material.min.js"></script>
    <style>
        body { margin: 0; font-family: 'Roboto', sans-serif; background: #f5f5f5; }
        canvas { width: 100vw; height: 100vh; display: block; }
        .toolbar { 
            position: fixed; top: 0; left: 0; width: 320px; 
            background: white; padding: 20px; box-shadow: 2px 2px 10px rgba(0,0,0,0.2);
            height: 100vh; overflow-y: auto;
            transition: transform 0.3s ease;
        }
        .hide-toolbar { transform: translateX(-110%); }
        .toggle-btn { position: fixed; top: 20px; left: 20px; z-index: 1000; }
        .controls label, .controls input, .controls select { display: block; margin-bottom: 10px; }
        .slider { width: 100%; }
        .slider-value { width: 20%; }
        #show-toolbar { position: fixed; top: 20px; left: 20px; z-index: 1000; display: none; }
        #generate-hidden { position: fixed; top: 20px; left: 84px; z-index: 1000; display: none; }
        #save-hidden { position: fixed; top: 20px; left: 148px; z-index: 1000; display: none; }
        .slider-wrap { display: flex; flex-direction: row; gap: 12px }
    </style>
</head>
<body>
    <button id="toggle-toolbar" class="toggle-btn mdl-button mdl-js-button mdl-button--fab mdl-button--colored">âœ–</button>
    <button id="show-toolbar" class="toggle-btn mdl-button mdl-js-button mdl-button--fab mdl-button--colored">â‰¡</button>
    <button id="generate-hidden" class="mdl-button mdl-js-button mdl-button--fab mdl-button--colored">â–¶</button>
    <button id="save-hidden" class="mdl-button mdl-js-button mdl-button--fab mdl-button--colored">ðŸ’¾</button>
    
    <div id="toolbar" class="toolbar">
        <br>
        <br>
        <h4>Image Scatter Generator</h4>
        <div class="controls">
            <label>Select Image</label>
            <input type="file" id="fileInput" accept="image/*">
            <label>Particle Size</label>
            <div class="slider-wrap">
                <input type="range" id="particleSize" class="slider" value="25" min="1" max="500" oninput="document.getElementById('particleSizeValue').value = this.value">
                <input type="number" id="particleSizeValue" class="slider-value" value="25" min="1" max="500" oninput="document.getElementById('particleSize').value = this.value">
            </div>
            <label>Particle Amount</label>
            <div class="slider-wrap">
                <input type="range" id="particleAmount" class="slider" value="10" min="1" max="250" oninput="document.getElementById('particleAmountValue').value = this.value">
                <input type="number" id="particleAmountValue" class="slider-value" value="10" min="1" max="1000" oninput="document.getElementById('particleAmount').value = this.value">
            </div>
            <label>Scatter Algorithm</label>
            <select id="scatterType">
                <option value="random">Random</option>
                <option value="organic">Organic</option>
            </select>
            <label>Seed</label>
            <input type="number" id="seed" value="42">
            <label>Background Color</label>
            <input type="color" id="bgColor" value="#ffffff">
            <button id="generate" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored">Generate</button>
            <button id="save" class="mdl-button mdl-js-button mdl-button--raised">Save as PNG</button>
        </div>
    </div>
    
    <canvas id="canvas"></canvas>
    
    <script>
        // TODO: 
        // Wrap around the screen / LOOP
        // Clamp incorrect values
        // x2 Render

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        document.getElementById('toggle-toolbar').addEventListener('click', () => {
            document.getElementById('toolbar').classList.add('hide-toolbar');
            document.getElementById('toggle-toolbar').style.display = 'none';
            document.getElementById('show-toolbar').style.display = 'block';
            document.getElementById('generate-hidden').style.display = 'block';
            document.getElementById('save-hidden').style.display = 'block';
        });
        
        document.getElementById('show-toolbar').addEventListener('click', () => {
            document.getElementById('toolbar').classList.remove('hide-toolbar');
            document.getElementById('toggle-toolbar').style.display = 'block';
            document.getElementById('show-toolbar').style.display = 'none';
            document.getElementById('generate-hidden').style.display = 'none';
            document.getElementById('save-hidden').style.display = 'none';
        });
        
        let image = new Image();
        document.getElementById('fileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    image.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });
        
        function generateParticles() {
            if (!image.src) return alert('Please select an image first.');
            
            const particleSize = parseInt(document.getElementById('particleSize').value);
            const particleAmount = parseInt(document.getElementById('particleAmountValue').value);
            const scatterType = document.getElementById('scatterType').value;

            let seedInput = document.getElementById('seed').value;
            if (!seedInput) {
                seed = Math.floor(Math.random() * 1000000);
                document.getElementById('seed').placeholder = seed
            } else {
                seed = parseInt(seedInput);
            }
            // if(!seedInput) seedAutofill = true
            const bgColor = document.getElementById('bgColor').value;

            ctx.fillStyle = bgColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            function perlinNoise(x, y) {
                function fade(t) {
                    return t * t * t * (t * (t * 6 - 15) + 10);
                }
                function lerp(a, b, t) {
                    return a + t * (b - a);
                }
                function grad(hash, x, y) {
                    const h = hash & 3;
                    const u = h < 2 ? x : y;
                    const v = h < 2 ? y : x;
                    return (h & 1 ? -u : u) + (h & 2 ? -2.0 * v : 2.0 * v);
                }
                const X = Math.floor(x) & 255;
                const Y = Math.floor(y) & 255;
                x -= Math.floor(x);
                y -= Math.floor(y);
                const u = fade(x);
                const v = fade(y);
                const p = new Array(512);
                for (let i = 0; i < 256; i++) p[256 + i] = p[i] = i;
                const aa = p[p[X] + Y];
                const ab = p[p[X] + Y + 1];
                const ba = p[p[X + 1] + Y];
                const bb = p[p[X + 1] + Y + 1];
                return lerp(lerp(grad(aa, x, y), grad(ba, x - 1, y), u),
                            lerp(grad(ab, x, y - 1), grad(bb, x - 1, y - 1), u), v);
            }  
            
            for (let i = 0; i < particleAmount; i++) {
                let x, y;
                if (scatterType === 'organic') {
                    x = (perlinNoise(i * 0.1, seed * 0.1) * 0.5 + 0.5) * canvas.width; 
                    y = (perlinNoise(i * 0.1, seed * 0.1 + 10) * 0.5 + 0.5) * canvas.height;
                    console.log(x,y);
                } else {
                    x = Math.random() * canvas.width;
                    y = Math.random() * canvas.height;
                }
                
                const aspectRatio = image.width / image.height;
                const width = particleSize * aspectRatio;
                ctx.drawImage(image, x, y, width, particleSize);
            }
        }

        function saveImage() {
            const fileInput = document.getElementById('fileInput');
            const fileName = fileInput.files.length > 0 ? fileInput.files[0].name.replace(/\..+$/, '') : 'image';
            const particleSize = document.getElementById('particleSize').value;
            const particleAmount = document.getElementById('particleAmountValue').value;
            const seed = document.getElementById('seed').value;
            const scatterType = document.getElementById('scatterType').value
                         
            const link = document.createElement('a');
            link.download = `${fileName}-${particleSize}px-${particleAmount}-${scatterType}-seed${seed}.png`;
            link.href = canvas.toDataURL();
            link.click();
        }
        
        document.getElementById('generate').addEventListener('click', generateParticles);
        document.getElementById('generate-hidden').addEventListener('click', generateParticles);
        document.getElementById('save').addEventListener('click', saveImage);
        document.getElementById('save-hidden').addEventListener('click', saveImage);
    </script>
</body>
</html>
